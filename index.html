<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SEND Map Prototype</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }

    #search-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      font-family: sans-serif;
    }

    #search-box {
      padding: 6px;
      width: 240px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  #menu {
  background: white;
  border-radius: 3px;
  padding: 10px;
  font-family: sans-serif;
  font-size: 13px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 11;
  pointer-events: auto;
}  
</style>
</head>
<body>
<div id="menu" class="mapboxgl-ctrl-top-right">
  <button id="toggle-menu-button">ğŸ§­ Layers â–¾</button>
  <div id="layer-toggles" style="display: none; margin-top: 8px;">
<label for="la-layer-select">Local Authority Layers</label><br>
<select id="la-layer-select" style="width: 240px;">
  <option value="none">None</option>
  <option value="suspensions">LA Suspensions</option>
  <option value="ehcp">EHCP Timeliness</option>
  <option value="inclusion">SEND Inclusion</option>
  <option value="exclusions">LA Exclusions</option>
</select><br>
    <label><input type="checkbox" id="toggle-schools"> School Locations</label><br>
    <label><input type="checkbox" id="toggle-sen-ring"> SEN Highlight</label><br>
    <label><input type="checkbox" id="toggle-transport"> Transport Stops</label><br>
<label><input type="checkbox" id="toggle-parentview"> Parent View</label><br>
<select id="question-select" style="margin-top: 5px; width: 240px;">
  <option value="ParentView_Q01">Q1 - Happy at school</option>
  <option value="ParentView_Q02">Q2 - Feels safe</option>
  <option value="ParentView_Q03">Q3 - Behaviour is good</option>
  <option value="ParentView_Q04">Q4 - Bullying handled well</option>
  <option value="ParentView_Q05">Q5 - Aware of curriculum</option>
  <option value="ParentView_Q06">Q6 - Concerns handled properly</option>
  <option value="ParentView_Q07a">Q7a - Has SEND needs</option>
  <option value="ParentView_Q07b">Q7b - SEND support is good</option>
  <option value="ParentView_Q08">Q8 - High expectations</option>
  <option value="ParentView_Q09">Q9 - Doing well</option>
  <option value="ParentView_Q10">Q10 - Knows how they're doing</option>
  <option value="ParentView_Q11">Q11 - Good subject range</option>
  <option value="ParentView_Q12">Q12 - Clubs and activities</option>
  <option value="ParentView_Q13">Q13 - Personal development</option>
  <option value="ParentView_Q14">Q14 - Recommend school</option>
</select>
<!-- ğŸ¯ School Filters -->
<div id="school-filters" style="margin-top: 12px; display: none;">
  <strong>Filter Schools</strong><br>

  <!-- Phase -->
  <label>Phase of School:</label><br>
  <label><input type="checkbox" class="filter-phase" value="Primary"> Primary</label><br>
  <label><input type="checkbox" class="filter-phase" value="Secondary"> Secondary</label><br>
  <label><input type="checkbox" class="filter-phase" value="All-through"> All-through</label><br>
  <label><input type="checkbox" class="filter-phase" value="Post-16"> Post-16</label><br><br>

  <!-- Gender Intake -->
  <label>Gender:</label><br>
  <label><input type="checkbox" class="filter-gender" value="Mixed"> Mixed</label><br>
  <label><input type="checkbox" class="filter-gender" value="Boys"> Boys</label><br>
  <label><input type="checkbox" class="filter-gender" value="Girls"> Girls</label><br><br>

  <!-- Bucketed Metrics -->
  <label>SEND Support Level:</label><br>
  <label><input type="checkbox" class="filter-send-support" value="Low"> Low</label><br>
  <label><input type="checkbox" class="filter-send-support" value="Moderate"> Moderate</label><br>
  <label><input type="checkbox" class="filter-send-support" value="High"> High</label><br><br>

  <label>EHCP Level:</label><br>
  <label><input type="checkbox" class="filter-ehcp" value="Low"> Low</label><br>
  <label><input type="checkbox" class="filter-ehcp" value="Moderate"> Moderate</label><br>
  <label><input type="checkbox" class="filter-ehcp" value="High"> High</label><br><br>

  <label>Exclusion Risk:</label><br>
  <label><input type="checkbox" class="filter-exclusion" value="Low"> Low</label><br>
  <label><input type="checkbox" class="filter-exclusion" value="Moderate"> Moderate</label><br>
  <label><input type="checkbox" class="filter-exclusion" value="High"> High</label><br>
</div>
  </div>
</div>
  <div id="map"></div>
  <div id="search-container">
    <input id="search-box" type="text" placeholder="Search Local Authority..." />
  </div>

  <script>
    let originalSchoolData = null;
    let isSchoolDataReady = false;
    let selectedQuestion = "ParentView_Q01";  // Default selected question
    let pinnedSchools = [];
    let laInclusionData = [];
    let laExclusionData = [];
    let sendNarratives = {};  // âœ… Global so all functions can access

fetch('data/processed/SENDNarrativefinal.csv')
  .then(res => res.text())
  .then(text => {
    const rows = [];
    let currentRow = [];
    let inQuotes = false;
    let value = '';

    for (let i = 0; i < text.length; i++) {
      const char = text[i];
      const nextChar = text[i + 1];

      if (char === '"' && nextChar === '"') {
        value += '"';
        i++; // skip the next quote
      } else if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === ',' && !inQuotes) {
        currentRow.push(value);
        value = '';
      } else if ((char === '\n' || char === '\r') && !inQuotes) {
        if (value || currentRow.length > 0) currentRow.push(value);
        if (currentRow.length > 0) rows.push(currentRow);
        currentRow = [];
        value = '';
        if (char === '\r' && nextChar === '\n') i++; // Windows \r\n
      } else {
        value += char;
      }
    }
    if (value || currentRow.length > 0) currentRow.push(value);
    if (currentRow.length > 0) rows.push(currentRow);

    const header = rows[0];
    const urnIndex = header.indexOf('URN');
    const narrativeIndex = header.findIndex(h => h.toLowerCase().includes('narrative'));

    rows.slice(1).forEach(cols => {
      const urn = cols[urnIndex]?.trim();
      const narrative = cols[narrativeIndex]?.trim();

      if (urn && narrative && narrative.length > 10) {
        sendNarratives[urn] = narrative.replace(/^"|"$/g, '').replace(/""/g, '"');
      }
    });

    console.log(`âœ… Loaded ${Object.keys(sendNarratives).length} SEND narratives`);
  });
  mapboxgl.accessToken = 'pk.eyJ1IjoiYm9ic29uaXRlIiwiYSI6ImNtOXpyeWc1aDFlY24ya3M3dm55a2oyNDcifQ.8H2wkga07prlTm_YpOQicA';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v10',
    center: [-1.5, 53.5],
    zoom: 5.4
  });

  document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('la-layer-select').value = 'none';
});
  let allFeatures = [];

  fetch('data/processed/LA_ExcSus_Merged.geojson')
  .then(res => res.json())
  .then(geojson => {
    allFeatures = geojson.features;

    map.on('load', () => {
      map.loadImage('pin-icon.png', (error, image) => {
  if (error) throw error;
  if (!map.hasImage('pin-icon')) {
    map.addImage('pin-icon', image);
  }
});
      map.addSource('suspensions', {
        type: 'geojson',
        data: geojson
      });
        // âœ… School Source and Layer
map.addSource('schools', {
  type: 'geojson',
  data: 'data/processed/OpenSchoolsSL_SEND_MERGED.geojson'
});

map.addSource('ehcp_timeliness', {
  type: 'geojson',
  data: 'data/processed/EHCP_Timeliness.geojson'
});
map.addSource('la_inclusion', {
  type: 'geojson',
  data: 'data/processed/LA_SEND_Merged.geojson'
});
map.addSource('la_exclusions', {
  type: 'geojson',
  data: 'data/processed/LA_ExcSus_Merged.geojson'
});

map.addLayer({
  id: 'la-exclusions-fill',
  type: 'fill',
  source: 'la_exclusions',
  filter: ['!=', ['get', 'region_name'], null],
  paint: {
 'fill-color': [
  'interpolate',
  ['linear'],
  ['to-number', ['get', 'LA_Overrepresentation']],
  2.0, '#2ecc71',     // Green for underrepresentation
  2.3, '#f1c40f',     // Yellow
  2.6, '#e67e22',     // Orange
  2.9, '#e74c3c',     // Red
  3.2, '#c0392b'      // Deep red for outliers
],
    'fill-opacity': 0.6
  },
  layout: {
    'visibility': 'none'
  }
});

map.addLayer({
  id: 'la-exclusions-outline',
  type: 'line',
  source: 'la_exclusions',
  filter: ['!=', ['get', 'region_name'], null],
  paint: {
    'line-color': '#000',
    'line-width': 0.5
  },
  layout: {
    'visibility': 'none'
  }
});
        map.addLayer({
          id: 'suspensions-fill',
          type: 'fill',
          source: 'suspensions',
          paint: {
            'fill-color': [
              'interpolate',
              ['linear'],
              ['get', 'susp_rate'],
              0, '#eff3ff',
              2, '#c6dbef',
              3, '#9ecae1',
              4, '#6baed6',
              5, '#3182bd',
              6, '#08519c'
            ],
            'fill-opacity': 0.6
          },
          layout: {'visibility':'none'}
        });

        map.addLayer({
          id: 'suspensions-outline',
          type: 'line',
          source: 'suspensions',
          paint: {
            'line-color': '#000',
            'line-width': 0.5
          },
          layout:{'visibility':'none'}
        });
map.addLayer({
  id: 'ehcp-timeliness-fill',
  type: 'fill',
  source: 'ehcp_timeliness',
  paint: {
 'fill-color': [
  'interpolate',
  ['linear'],
  ['to-number', ['get', 'no_exc_20week_rate']],
  40, '#a50f15',   // dark red = bad
  50, '#de2d26',
  60, '#fb6a4a',
  70, '#fcae91',
  80, '#fee5d9',
  90, '#d9f0a3',
  95, '#78c679',
  100, '#238443'   // dark green = excellent
],
    'fill-opacity': 0.6
  },
  layout: {
    'visibility': 'none'  // default hidden, toggled via menu
  }
});

map.addLayer({
  id: 'ehcp-timeliness-outline',
  type: 'line',
  source: 'ehcp_timeliness',
  paint: {
    'line-color': '#000',
    'line-width': 0.5
  },
  layout: {
    'visibility': 'none'
  }
});
map.addLayer({
  id: 'la-inclusion-fill',
  type: 'fill',
  source: 'la_inclusion',
  paint: {
    'fill-color': [
      'interpolate',
      ['linear'],
      ['to-number', ['get', 'inclusion_rate']],
      1.5, '#deebf7',
      2.0, '#9ecae1',
      2.5, '#6baed6',
      3.0, '#4292c6',
      3.5, '#2171b5',
      4.0, '#084594'
    ],
    'fill-opacity': 0.6
  },
  layout: {
    'visibility': 'none'
  }
});

map.addLayer({
  id: 'la-inclusion-outline',
  type: 'line',
  source: 'la_inclusion',
  paint: {
    'line-color': '#000',
    'line-width': 0.5
  },
  layout: {
    'visibility': 'none'
  }
});
map.addSource('pinned-schools', {
  type: 'geojson',
  data: {
    type: 'FeatureCollection',
    features: []
  }
});

map.addLayer({
  id: 'pinned-icons',
  type: 'symbol',
  source: 'pinned-schools',
  layout: {
    'icon-image': 'pin-icon',
    'icon-size': 0.1,
    'icon-allow-overlap': true
  }
});  
// âœ… Immediately add the school circle layer without conditions
  map.addLayer({
  id: 'schools-sen-ring',
  type: 'circle',
  source: 'schools',
  filter: ['==', 'HasSENProvision', true],
  paint: {
    'circle-radius': 8,
    'circle-color': 'transparent',
    'circle-stroke-color': '#5b00ae',
    'circle-stroke-width': 3
  },
  layout: { 'visibility': 'none' }  // toggle via checkbox
});
// ğŸŸ¢ Parent View score ring (initial test with Q01)
map.addLayer({
  id: 'parentview-rings',
  type: 'circle',
  source: 'schools',
  paint: {
    'circle-radius': 10,
    'circle-color': '#ccc',  // neutral default until updated
    'circle-opacity': 0.5,
    'circle-stroke-color': '#000',
    'circle-stroke-width': 0.5
  },
  layout: { 'visibility': 'none' }
});

  map.addLayer({
    id: 'schools-circle',
    type: 'circle',
    source: 'schools',
    paint: {
      'circle-radius': 4,
      'circle-color': '#f03b20',
      'circle-stroke-color': '#fff',
      'circle-stroke-width': 0.5
    },
    layout:{'visibility':'none'}
  });


map.addSource('postcode-districts', {
  type: 'geojson',
  data: 'data/processed/EnglishPostcodeDistricts_cleaned.geojson'
});

// ğŸš Add transport source
fetch('data/processed/TransportIcons_Corrected.geojson')
  .then(res => res.json())
  .then(data => {
    transportGeojson = data;

    map.addSource('transport', {
      type: 'geojson',
      data: data
    });

// ğŸš Add transport layer with built-in icons
map.loadImage('https://docs.mapbox.com/mapbox-gl-js/assets/custom_marker.png', (error, image) => {
  if (error) throw error;

  if (!map.hasImage('custom-marker')) {
    map.addImage('custom-marker', image);
  }

  map.addLayer({
    id: 'transport-icons',
    type: 'symbol',
    source: 'transport',
    layout: {
      'icon-image': ['get', 'icon'], // 'bus', 'rail', or 'car'
      'icon-size': 0.7,
      'icon-allow-overlap': true,
'visibility': 'none'
    }
  });
});
});
        // Popup hover
        const popup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false });

        map.on('mousemove', 'suspensions-fill', (e) => {
          map.getCanvas().style.cursor = 'pointer';
          const props = e.features[0].properties;
          popup
            .setLngLat(e.lngLat)
            .setHTML(`<strong>${props.la_name}</strong><br>Suspension rate: ${props.suspension_rate_label}`)
            .addTo(map);
        });

        map.on('mouseleave', 'suspensions-fill', () => {
          map.getCanvas().style.cursor = '';
          popup.remove();
        });

map.on('mousemove', 'ehcp-timeliness-fill', (e) => {
  map.getCanvas().style.cursor = 'pointer';
  const props = e.features[0].properties;
  popup
    .setLngLat(e.lngLat)
    .setHTML(`<strong>${props.la_name_y}</strong><br>${Number(props.no_exc_20week_rate).toFixed(1)}% issued within 20 weeks`)
    .addTo(map);
});

map.on('mouseleave', 'ehcp-timeliness-fill', () => {
  map.getCanvas().style.cursor = '';
  popup.remove();
});
map.on('mousemove', 'la-inclusion-fill', (e) => {
  map.getCanvas().style.cursor = 'pointer';
  const p = e.features[0].properties;

  // Calculate up/down arrow
  const arrow = (value, avg) => {
    if (value > avg) return 'ğŸ”¼';
    if (value < avg) return 'ğŸ”½';
    return 'âºï¸';
  };

  const sup = parseFloat(p.sen_support_percent).toFixed(1);
  const ehcp = parseFloat(p.ehc_plan_percent).toFixed(1);
  const incl = parseFloat(p.inclusion_rate).toFixed(2);
  const regSup = parseFloat(p.region_sen_support_avg).toFixed(1);
  const regEhcp = parseFloat(p.region_ehcp_avg).toFixed(1);
  const regIncl = parseFloat(p.region_inclusion_avg).toFixed(2);

  const supportArrow = arrow(sup, regSup);
  const ehcpArrow = arrow(ehcp, regEhcp);
  const inclArrow = arrow(incl, regIncl);

  const html = `
    <strong>${p.CTYUA24NM}</strong><br>
    ğŸ§© SEN Support: ${sup}% (${regSup}% ${supportArrow})<br>
    ğŸ“˜ EHCP: ${ehcp}% (${regEhcp}% ${ehcpArrow})<br>
    âš–ï¸ Inclusion Ratio: ${incl} (${regIncl} ${inclArrow})<br>
    <em>${p.parent_interpretation}</em>
  `;

  popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
});

map.on('mousemove', 'la-exclusions-fill', (e) => {
  map.getCanvas().style.cursor = 'pointer';
  const p = e.features[0].properties;

  const format = (x, d = 1) => {
    const val = Number(x);
    return isNaN(val) || val === null ? 'N/A' : `${val.toFixed(d)}%`;
  };

  const renderBar = (val, color = '#ccc') => {
    const width = Math.min(100, Math.max(0, Number(val))).toFixed(1);
    return `<div style="background:${color};width:${width}%;height:10px;border-radius:3px;"></div>`;
  };

  // Extract values
  const s = p["SEND_susp_rate"] * 100;
  const o = p["SEND_one_plus_susp_rate"] * 100;
  const e_ = p["SEND_excl_rate"] * 100;

  const s_la = p["LA_susp_rate"] * 100;
  const o_la = p["LA_one_plus_rate"] * 100;
  const e_la = p["LA_excl_rate"] * 100;

  const s_reg = p["REG_susp_rate"] * 100;
  const o_reg = p["REG_one_plus_rate"] * 100;
  const e_reg = p["REG_excl_rate"] * 100;

  const over = p["LA_Overrepresentation"];
  const over_reg = p["REG_Overrepresentation"];

  if (isNaN(over)) {
    popup.setLngLat(e.lngLat).setHTML(`<strong>${p.CTYUA24NM}</strong><br><em>âš ï¸ No valid SEN subgroup data available for this LA.</em>`).addTo(map);
    return;
  }

  const html = `
  <style>
    .mapboxgl-popup-content {
      min-width: 320px !important;
    }
  </style>
  <div style="min-width: 320px;">
  <strong>${p.CTYUA24NM}</strong><br><br>
  <table style="font-size:12px; width: 100%;">
      <thead>
        <tr>
          <th style="width:70px;"></th>
          <th style="text-align:left;">Suspension</th>
          <th style="text-align:left;">One+ Susp.</th>
          <th style="text-align:left;">Exclusion</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span style="color:#c0392b;">â— SEND</span></td>
          <td>${renderBar(s, '#e74c3c')} ${format(s)}</td>
          <td>${renderBar(o, '#e74c3c')} ${format(o)}</td>
          <td>${renderBar(e_, '#e74c3c')} ${format(e_)}</td>
        </tr>
        <tr>
          <td><span style="color:#2c3e50;">â— LA Avg</span></td>
          <td>${renderBar(s_la, '#7f8c8d')} ${format(s_la)}</td>
          <td>${renderBar(o_la, '#7f8c8d')} ${format(o_la)}</td>
          <td>${renderBar(e_la, '#7f8c8d')} ${format(e_la)}</td>
        </tr>
        <tr>
          <td><span style="color:#2980b9;">â— Region SEND</span></td>
          <td>${renderBar(s_reg, '#3498db')} ${format(s_reg)}</td>
          <td>${renderBar(o_reg, '#3498db')} ${format(o_reg)}</td>
          <td>${renderBar(e_reg, '#3498db')} ${format(e_reg)}</td>
        </tr>
      </tbody>
    </table>
    <br>
    <span style="font-size:12px;">âš–ï¸ <b>Overrepresentation:</b> ${Number(over).toFixed(2)}x<br>
    ğŸ“ <b>Regional Avg:</b> ${Number(over_reg).toFixed(2)}x</span>
    <br><em style="font-size:11px;">
    SEND pupils in this LA were ${Number(over).toFixed(2)}Ã— more likely than others to be suspended.
    </em></div>
  `;

  popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
});

map.on('mouseleave', 'la-exclusions-fill', () => {
  map.getCanvas().style.cursor = '';
  popup.remove();
});
        // Search logic (global)
       document.getElementById('search-box').addEventListener('keydown', async (e) => {
  if (e.key !== 'Enter') return;

  const query = e.target.value.trim().toUpperCase();

  // 1. Search LA features
  const laMatch = allFeatures.find(f =>
    f.properties.la_name && f.properties.la_name.toLowerCase().includes(query.toLowerCase())
  );
  if (laMatch) {
    const bounds = turf.bbox(laMatch);
    map.fitBounds(bounds, { padding: 50 });
    return;
  }

  // 2. Search schools
  const schoolSource = map.getSource('schools');
  if (schoolSource) {
    const schoolData = await fetch('data/processed/OpenSchoolsSL_SEND_MERGED.geojson').then(r => r.json());
    const schoolMatch = schoolData.features.find(f =>
      f.properties.EstablishmentName.toLowerCase().includes(query.toLowerCase())
    );
    if (schoolMatch) {
      const coords = schoolMatch.geometry.coordinates;
      map.flyTo({ center: coords, zoom: 14 });
      return;
    }
  }

  // 3. Search postcode districts (e.g., SW1, B12, E17)
  if (/^[A-Z]{1,2}[0-9][0-9A-Z]?$/.test(query)) {
    try {
      const postcodeData = await fetch('data/processed/EnglishPostcodeDistricts_cleaned.geojson')
        .then(r => r.json());

      console.log('âœ… Postcode data loaded:', postcodeData.features.length);
      
      const match = postcodeData.features.find(f => {
        const code = f.properties["Postcode district"];
        if (!code) return false;
        const isMatch = code.toUpperCase() === query;
        if (isMatch) console.log(`âœ… Found match for postcode: ${code}`);
        return isMatch;
      });

      if (match) {
        const bounds = turf.bbox(match);
        console.log(`ğŸ“¦ Bounding box for ${query}:`, bounds);
        map.fitBounds(bounds, { padding: 40 });
      } else {
        console.warn(`âŒ No match found for postcode: ${query}`);
      }
    } catch (err) {
      console.error('âŒ Error searching postcode district:', err);
    }
  }
});  // ğŸ‘ˆ FINAL CLOSING for entire search-box listener

// ğŸ« School-level tooltip logic
const schoolPopup = new mapboxgl.Popup({
  closeButton: false,
  closeOnClick: false
});

map.on('click', 'schools-circle', (e) => {
  const schoolCoords = e.features[0].geometry.coordinates;
  const p = e.features[0].properties;
  const schoolPoint = turf.point(schoolCoords);
  const nearest = transportGeojson.features
    .map(f => {
      const dist = turf.distance(schoolPoint, f);
      return { feature: f, distance: dist };
    })
    .sort((a, b) => a.distance - b.distance)
    .slice(0, 5);

  const transportIcons = {
    AIR: 'âœˆï¸ Airport', BCE: 'ğŸšŒ Bus (Council)', BCQ: 'ğŸšŒ Bus (Qualified)', BCS: 'ğŸšŒ Bus (School)',
    BCT: 'ğŸšŒ Bus (TfL)', BST: 'ğŸšŒ Bus (TfL)', FBT: 'ğŸš Flexible Transport', FER: 'â›´ï¸ Ferry Stop',
    FTD: 'â›´ï¸ Ferry Terminal', GAT: 'ğŸš‡ Gateway', MET: 'ğŸš† Metro', PLT: 'ğŸš‡ Tube Platform',
    RLY: 'ğŸš‰ Rail Station', RPL: 'ğŸš† Rail Platform', RSE: 'ğŸšŠ Rail Entry', STR: 'ğŸš Street Pickup',
    TMU: 'ğŸš Minibus Hub', TXR: 'ğŸš– Taxi Rank'
  };

  const capacity = p.SchoolCapacity;
  const pupils = p.NumberOfPupils;
  const utilisation = capacity && pupils ? Math.round((pupils / capacity) * 100) : 'N/A';

  let html = `
<strong>${p.EstablishmentName}</strong> 
<button onclick="pinSchool('${p.URN}', this)" style="float:right; font-size:12px;">ğŸ“Œ Pin</button><br>`;
html += `<em>${p['TypeOfEstablishment (name)'] || 'Type Unknown'}</em><br>`;
  html += `ğŸ“ Phase: ${p.Is_Secondary === 1 ? 'Secondary' : p.Is_Primary === 1 ? 'Primary' : 'N/A'}<br>`;
  html += `ğŸ‘« Gender: ${p['Gender (name)'] || 'Mixed'}<br>`;
  html += `ğŸ« Pupils: ${p.NumberOfPupils || 'N/A'}<br>`;
  html += `ğŸ“¦ Capacity: ${p.SchoolCapacity || 'N/A'}<br>`;
  html += `ğŸ“ˆ Utilisation: ${utilisation !== 'N/A' ? utilisation + '%' : 'N/A'}<br>`;
  // âœ… Add SEN Provision tooltip line (safe â€“ from preprocessed field)
const provision = p.SEN_Provision_List || 'Not available';
html += `ğŸ§  SEN Provision: ${provision}<br>`;
// Add inclusion-related metrics
html += `ğŸ§© SEN Support: ${typeof p.Pct_SENSupport === 'number' ? (p.Pct_SENSupport * 100).toFixed(1) + '%' : 'Not available'}<br>`;
html += `ğŸ“˜ EHCP: ${typeof p.Pct_EHCP === 'number' ? (p.Pct_EHCP * 100).toFixed(1) + '%' : 'Not available'}<br>`;
html += `ğŸŸ¥ Susp. Rate: ${p.susp_rate ? parseFloat(p.susp_rate).toFixed(1) + '%' : 'N/A'}<br>`;
  html += `<hr><em>Nearest Transport Stops:</em><ul>`;
  nearest.forEach(item => {
    const subtype = item.feature.properties.Subtype;
    const label = transportIcons[subtype?.toUpperCase()] || subtype;
    html += `<li>${label} â€” ${item.feature.properties.Name} (${item.distance.toFixed(2)} km)</li>`;
  });
  html += '</ul>';

    const clickPopup = new mapboxgl.Popup()
    .setLngLat(schoolCoords)
    .setHTML(html)
    .addTo(map);

  window.activeSchoolPopup = clickPopup;  // Store for later use
});
// ğŸ›‘ Transport-layer hover popup
const transportPopup = new mapboxgl.Popup({
  closeButton: false,
  closeOnClick: false
});

map.on('mouseenter', 'transport-icons', (e) => {
  map.getCanvas().style.cursor = 'pointer';
  const props = e.features[0].properties;
  transportPopup.setLngLat(e.lngLat)
    .setHTML(`<strong>${props.Name}</strong><br>${props.SubType}`)
    .addTo(map);
});

map.on('mouseleave', 'transport-icons', () => {
  map.getCanvas().style.cursor = '';
  transportPopup.remove();
});


  document.getElementById('toggle-schools').addEventListener('change', (e) => {
  const visibility = e.target.checked ? 'visible' : 'none';
  map.setLayoutProperty('schools-circle', 'visibility', visibility);

  // ğŸ§  Show or hide the school filter panel accordingly
  const filterPanel = document.getElementById('school-filters');
  filterPanel.style.display = e.target.checked ? 'block' : 'none';
});
document.getElementById('toggle-sen-ring').addEventListener('change', (e) => {
  const visibility = e.target.checked ? 'visible' : 'none';
  map.setLayoutProperty('schools-sen-ring', 'visibility', visibility);
});
document.getElementById('toggle-transport').addEventListener('change', (e) => {
  const visibility = e.target.checked ? 'visible' : 'none';
  map.setLayoutProperty('transport-icons', 'visibility', visibility);
});
document.getElementById('toggle-parentview').addEventListener('change', (e) => {
  const visibility = e.target.checked ? 'visible' : 'none';
  map.setLayoutProperty('parentview-rings', 'visibility', visibility);

  if (visibility === 'visible') {
    map.setFilter('parentview-rings', [
      'all',
      ['!=', ['get', selectedQuestion], null],
      ['!=', ['get', selectedQuestion], '']
    ]);
    map.setPaintProperty('parentview-rings', 'circle-color', [
  'case',
  ['<', ['get', selectedQuestion], 0.7], '#e74c3c',    // red
  ['<', ['get', selectedQuestion], 0.85], '#f1c40f',   // yellow
  '#2ecc71'                                            // green
]);
  }
});
document.getElementById('question-select').addEventListener('change', (e) => {
  selectedQuestion = e.target.value;
  const parentViewOn = document.getElementById('toggle-parentview').checked;

  if (map.getLayer('parentview-rings') && parentViewOn) {
    map.setFilter('parentview-rings', [
      'all',
      ['!=', ['get', selectedQuestion], null],
      ['!=', ['get', selectedQuestion], '']
    ]);
    map.setPaintProperty('parentview-rings', 'circle-color', [
  'case',
  ['<', ['get', selectedQuestion], 0.7], '#e74c3c',    // red
  ['<', ['get', selectedQuestion], 0.85], '#f1c40f',   // yellow
  '#2ecc71'                                            // green
]);
  }
});
document.getElementById('la-layer-select').addEventListener('change', (e) => {
  const selection = e.target.value;

  const layers = {
    suspensions: ['suspensions-fill', 'suspensions-outline'],
    ehcp: ['ehcp-timeliness-fill', 'ehcp-timeliness-outline'],
    inclusion: ['la-inclusion-fill', 'la-inclusion-outline'],
    exclusions: ['la-exclusions-fill', 'la-exclusions-outline']
  };

  // Hide all LA layers first
  Object.values(layers).flat().forEach(layer => {
    if (map.getLayer(layer)) {
      map.setLayoutProperty(layer, 'visibility', 'none');
    }
  });

  // Show selected layer set
  if (layers[selection]) {
    layers[selection].forEach(layer => {
      if (map.getLayer(layer)) {
        map.setLayoutProperty(layer, 'visibility', 'visible');
      }
    });
  }
});
document.getElementById('toggle-menu-button').addEventListener('click', () => {
  const toggles = document.getElementById('layer-toggles');
  toggles.style.display = toggles.style.display === 'none' ? 'block' : 'none';
});
function applySchoolFilters() {
  const getCheckedValues = (cls) =>
    Array.from(document.querySelectorAll(`input.${cls}:checked`)).map(cb => cb.value);

  const phase = getCheckedValues('filter-phase');
  const type = getCheckedValues('filter-type');
  const gender = getCheckedValues('filter-gender');
  const send = getCheckedValues('filter-send-support');
  const ehcp = getCheckedValues('filter-ehcp');
  const excl = getCheckedValues('filter-exclusion');

  const filters = ['all'];

  if (phase.length > 0) {
    filters.push(['in', ['get', 'Phase_Label'], ['literal', phase]]);
  }
  if (type.length > 0) {
    filters.push(['in', ['get', 'School_Type'], ['literal', type]]);
  }
  if (gender.length > 0) {
    filters.push(['in', ['get', 'Gender_Intake'], ['literal', gender]]);
  }
  if (send.length > 0) {
    filters.push(['in', ['get', 'SEND_Support_Bucket'], ['literal', send]]);
  }
  if (ehcp.length > 0) {
    filters.push(['in', ['get', 'EHCP_Level_Bucket'], ['literal', ehcp]]);
  }
  if (excl.length > 0) {
    filters.push(['in', ['get', 'Exclusion_Risk_Bucket'], ['literal', excl]]);
  }

  map.setFilter('schools-circle', filters);
}

// â±ï¸ Hook up event listeners for each checkbox
[
  'filter-phase', 'filter-type', 'filter-gender',
  'filter-send-support', 'filter-ehcp', 'filter-exclusion'
].forEach(cls => {
  document.querySelectorAll(`input.${cls}`).forEach(cb => {
    cb.addEventListener('change', applySchoolFilters);
  });
});
// Load LA Inclusion and Exclusion Data for Benchmarking
fetch('data/processed/LA_SEND_Merged.geojson')
  .then(res => res.json())
  .then(data => laInclusionData = data.features);

fetch('data/processed/LA_ExcSus_Merged.geojson')
  .then(res => res.json())
  .then(data => {
    laExclusionData = data.features;
    console.log("âœ… LA Exclusion dataset loaded:", laExclusionData.length, "features");
    console.log("ğŸ§ª Sample LA:", laExclusionData[0].properties);
  });
});  // ğŸ‘ˆ Closes the map.on('load', ...) block
    });
function pinSchool(urn, button) {
  if (pinnedSchools.includes(urn)) return;

  fetch('data/processed/OpenSchoolsSL_SEND_MERGED.geojson')
    .then(res => res.json())
    .then(data => {
      const match = data.features.find(f => f.properties.URN == urn);
      if (!match) return;

      pinnedSchools.push(urn);

      const p = match.properties;

      const card = document.createElement('div');
      card.style.minWidth = '220px';
card.style.border = '1px solid #ccc';
card.style.borderRadius = '6px';
card.style.padding = '6px';
card.style.background = '#fafafa';
card.style.fontSize = '12px';

  card.innerHTML = `
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <strong>${p.EstablishmentName}</strong>
    <button onclick="unpinSchool('${urn}', this.parentElement.parentElement)" style="background:none;border:none;font-size:16px;cursor:pointer;">âŒ</button>
  </div>
  <em>${p['TypeOfEstablishment (name)'] || 'Type Unknown'}</em><br>
  ğŸ“ Phase: ${p.Is_Secondary === 1 ? 'Secondary' : p.Is_Primary === 1 ? 'Primary' : 'N/A'}<br>
  ğŸ‘« Gender: ${p['Gender (name)'] || 'Mixed'}<br>
  ğŸ« Pupils: ${p.NumberOfPupils || 'N/A'}<br>
  ğŸ“¦ Capacity: ${p.SchoolCapacity || 'N/A'}<br>
  ğŸ“ˆ Utilisation: ${p.NumberOfPupils && p.SchoolCapacity ? Math.round((p.NumberOfPupils / p.SchoolCapacity) * 100) + '%' : 'N/A'}<br>
  ğŸ§  SEN Provision: ${p.SEN_Provision_List || 'Not available'}<br>
  ğŸ§© SEN Support: ${typeof p.Pct_SENSupport === 'number' ? (p.Pct_SENSupport * 100).toFixed(1) + '%' : 'Not available'}<br>
  ğŸ“˜ EHCP: ${typeof p.Pct_EHCP === 'number' ? (p.Pct_EHCP * 100).toFixed(1) + '%' : 'Not available'}<br>
  ğŸŸ¥ Susp. Rate: ${p.susp_rate ? parseFloat(p.susp_rate).toFixed(1) + '%' : 'N/A'}<br>
`;

      document.getElementById('comparison-panel').style.display = 'block';
      document.getElementById('comparison-content').appendChild(card);

            button.disabled = true;
      button.innerText = 'ğŸ“Œ Pinned';

const newFeature = {
  type: 'Feature',
  geometry: match.geometry,
  properties: { URN: urn }
};

const currentData = map.getSource('pinned-schools')._data;
currentData.features.push(newFeature);
map.getSource('pinned-schools').setData(currentData);
      if (window.activeSchoolPopup) {
  window.activeSchoolPopup.remove();
  window.activeSchoolPopup = null;
} // âœ… close popup after pinning
    });
}
function unpinSchool(urn, cardElement) {
  pinnedSchools = pinnedSchools.filter(id => id !== urn);
  const source = map.getSource('pinned-schools');
const currentData = source._data;
currentData.features = currentData.features.filter(f => f.properties.URN !== urn);
source.setData(currentData);
  cardElement.remove();
  if (pinnedSchools.length === 0) {
    document.getElementById('comparison-panel').style.display = 'none';
  }
}
</script>
<script>
function showFullProfile() {
  fetch('data/processed/OpenSchoolsSL_SEND_MERGED.geojson')
    .then(res => res.json())
    .then(data => {
      const profileArea = document.getElementById('profile-modal-content');
      const title = document.getElementById('profile-modal-title');

      profileArea.innerHTML = ''; // clear old content

      if (pinnedSchools.length === 0) return;

      title.innerText = pinnedSchools.length === 1
        ? 'School Profile'
        : 'Compare Profiles';

      pinnedSchools.forEach(urn => {
        const match = data.features.find(f => f.properties.URN == urn);
        if (!match) return;
        const p = match.properties;

        const capacity = p.SchoolCapacity;
        const pupils = p.NumberOfPupils;
        const utilisation = capacity && pupils ? Math.round((pupils / capacity) * 100) : 'N/A';

        const provision = p.SEN_Provision_List || 'Not available';
        const send = typeof p.Pct_SENSupport === 'number' ? (p.Pct_SENSupport * 100).toFixed(1) + '%' : 'N/A';
        const ehcp = typeof p.Pct_EHCP === 'number' ? (p.Pct_EHCP * 100).toFixed(1) + '%' : 'N/A';
        const susp = p.susp_rate ? parseFloat(p.susp_rate).toFixed(1) + '%' : 'N/A';

        // ğŸ« Summary card
        const html = `
          <div style="border:1px solid #ccc; border-radius:6px; padding:12px; margin-bottom:16px; width: 320px; flex-shrink: 0;">
            <h4>${p.EstablishmentName}</h4>
            <p>
              ğŸ“ Phase: ${p.Is_Secondary === 1 ? 'Secondary' : p.Is_Primary === 1 ? 'Primary' : 'N/A'}<br>
              ğŸ‘« Gender: ${p['Gender (name)'] || 'Mixed'}<br>
              ğŸ§‘â€ğŸ¤â€ğŸ§‘ Pupils: ${pupils || 'N/A'}<br>
              ğŸ“¦ Capacity: ${capacity || 'N/A'}<br>
              ğŸ“ˆ Utilisation: ${utilisation !== 'N/A' ? utilisation + '%' : 'N/A'}
            </p>

            <hr>
            <strong>SEND Provision</strong><br>
            ğŸ§  ${provision}<br><br>

            <strong>Inclusion Metrics</strong><br>
            ğŸ§© SEN Support: ${send}<br>
            ğŸ“˜ EHCP: ${ehcp}<br>
            ğŸŸ¥ Susp. Rate: ${susp}<br><br>

            <strong>Ofsted on SEND:</strong><br>
${sendNarratives[p.URN]
  ? (() => {
      const full = sendNarratives[p.URN].replace(/`/g, '\\`').trim();
      const short = full.length > 200 ? full.slice(0, 200).trim() + '...' : full;
      const hasMore = full.length > 200;

      return `
        <span id="short-${urn}" style="display: inline;">${short}</span>
        <span id="full-${urn}" style="display: none;">${full}</span>
        ${hasMore
          ? `<button id="toggle-${urn}" onclick="
              const short = document.getElementById('short-${urn}');
              const full = document.getElementById('full-${urn}');
              const btn = document.getElementById('toggle-${urn}');
              const isShort = short.style.display !== 'none';
              short.style.display = isShort ? 'none' : 'inline';
              full.style.display = isShort ? 'inline' : 'none';
              btn.innerText = isShort ? 'ğŸ”™ Read less' : 'ğŸ” Read more';
            "
            style="margin-top:4px; font-size:12px; background:none; border:none; color:#3498db; cursor:pointer;">
            ğŸ” Read more</button>`
          : ''
        }
        <br>
        <a href="https://reports.ofsted.gov.uk/provider/23/${p.URN}" target="_blank" style="font-size:12px; display:inline-block; margin-top:4px;">ğŸ“„ View full Ofsted report</a><br>
      `;
    })()
  : `<em>No SEND-specific comments found in recent Ofsted report.</em><br>`
}
            <strong>Nearest Transport:</strong>
            <ul style="padding-left:16px;" id="transport-${urn}">Loading...</ul>

            <div id="benchmark-${urn}" style="margin-top:12px;"></div>
          </div>
        `;
        profileArea.innerHTML += html;

        // ğŸ“ After DOM insert, fill transport and benchmark
        setTimeout(() => {
        // ğŸ§­ Add fallback for missing lat/lng
        if (!p.latitude || !p.longitude) {
          const coords = match.geometry.coordinates;
          p.longitude = coords[0];
          p.latitude = coords[1];
        }

        populateTransportList(p, `transport-${urn}`);
        populateLABenchmark(p, `benchmark-${urn}`);
      }, 50);
      });

      document.getElementById('profile-modal').style.display = 'block';
    });
}
function populateTransportList(p, containerId) {
  const schoolCoords = [p.longitude, p.latitude];
  const schoolPoint = turf.point(schoolCoords);
  const nearest = transportGeojson.features
    .map(f => {
      const dist = turf.distance(schoolPoint, f);
      return { feature: f, distance: dist };
    })
    .sort((a, b) => a.distance - b.distance)
    .slice(0, 3);

  const icons = {
    AIR: 'âœˆï¸', BCE: 'ğŸšŒ', BCQ: 'ğŸšŒ', BCS: 'ğŸšŒ', BCT: 'ğŸšŒ', BST: 'ğŸšŒ',
    FBT: 'ğŸš', FER: 'â›´ï¸', FTD: 'â›´ï¸', GAT: 'ğŸš‡', MET: 'ğŸš†',
    PLT: 'ğŸš‡', RLY: 'ğŸš‰', RPL: 'ğŸš†', RSE: 'ğŸšŠ', STR: 'ğŸš',
    TMU: 'ğŸš', TXR: 'ğŸš–'
  };

  const ul = document.getElementById(containerId);
  ul.innerHTML = '';
  nearest.forEach(item => {
    const f = item.feature;
    const label = icons[f.properties.Subtype] || '';
    ul.innerHTML += `<li>${label} ${f.properties.Subtype} - ${f.properties.Name} (${item.distance.toFixed(2)} km)</li>`;
  });
}

function populateLABenchmark(p, containerId) {
  const laName = p.LA_Name;
  const container = document.getElementById(containerId);

  const inc = laInclusionData.find(f =>
    f.properties.CTYUA24NM?.trim().toLowerCase() === laName?.trim().toLowerCase()
  )?.properties || {};

  const excl = laExclusionData.find(f =>
    f.properties.CTYUA24NM?.trim().toLowerCase() === laName?.trim().toLowerCase()
  )?.properties || {};

  // âœ… Converts decimal to percentage (e.g., 0.15 â†’ 15.0), or returns N/A
  const toPct = (val) => {
    const num = Number(val);
    return isNaN(num) ? 'N/A' : (num * 100).toFixed(1);
  };

  // âœ… Suspensions already stored as a proper percentage value (e.g. 7.9), so we just round
  const formatSusp = (val) => {
    const num = Number(val);
    return isNaN(num) ? 'N/A' : num.toFixed(1);
  };

  const senSupSchool = toPct(p.Pct_SENSupport);
  const ehcpSchool = toPct(p.Pct_EHCP);
  const suspSchool = formatSusp(p.susp_rate);

  const senSupLA = toPct(inc.sen_support_percent / 100);  // stored as string %, convert to decimal
  const ehcpLA = toPct(inc.ehc_plan_percent / 100);
  const suspLA = formatSusp(excl.susp_rate);  // stored already as percentage

  const renderBar = (val, color = '#ccc') => {
    if (val === 'N/A') return `<span style="color:#888;">N/A</span>`;
    return `<div style="background:${color};width:${val}%;height:10px;border-radius:3px;"></div>`;
  };

  const html = `
    <hr>
    <strong>ğŸ“Š LA Benchmark Comparison</strong>
    <div style="font-size:12px;">
      ğŸ§© SEN Support: ${senSupSchool}% vs LA avg ${senSupLA}%<br>
      ${renderBar(senSupSchool, '#27ae60')} ${renderBar(senSupLA, '#bdc3c7')}<br>

      ğŸ“˜ EHCP: ${ehcpSchool}% vs LA avg ${ehcpLA}%<br>
      ${renderBar(ehcpSchool, '#2980b9')} ${renderBar(ehcpLA, '#bdc3c7')}<br>

      ğŸŸ¥ Susp. Rate: ${suspSchool}% vs LA avg ${suspLA}%<br>
      ${renderBar(suspSchool, '#e74c3c')} ${renderBar(suspLA, '#bdc3c7')}
    </div>
  `;

  container.innerHTML = html;
}
</script>
<!-- ğŸ” SCHOOL PROFILE SIDEBAR -->
<div id="school-profile" style="display: none; position: absolute; top: 80px; right: 10px; width: 320px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); padding: 12px; z-index: 999;">
  <div id="school-profile-content"></div>
</div>

<!-- ğŸ“Œ COMPARISON PANEL (PINNED SCHOOLS) -->
<div id="comparison-panel" style="display: none; position: absolute; bottom: 10px; left: 10px; width: calc(100% - 20px); background: white; border-radius: 6px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 998;">
  <div id="comparison-content" style="display: flex; gap: 12px; overflow-x: auto;"></div>
  <div style="text-align: right; margin-top: 10px;">
    <button onclick="showFullProfile()" style="padding: 6px 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
      ğŸ“Š Profile
    </button>
  </div>
</div>
<!-- ğŸ§  FULL PROFILE MODAL -->
<div id="profile-modal" style="display: none; position: fixed; top: 10%; left: 50%; transform: translateX(-50%); width: 90%; max-width: 1200px; max-height: 80vh; overflow-y: auto; background: white; border-radius: 8px; box-shadow: 0 2px 20px rgba(0,0,0,0.3); padding: 16px; z-index: 9999;">
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <h3 id="profile-modal-title" style="margin: 0;">School Profile</h3>
    <button onclick="document.getElementById('profile-modal').style.display='none'" style="font-size: 20px; border: none; background: none; cursor: pointer;">âŒ</button>
  </div>
  <hr>
  <div id="profile-modal-content" style="
  display: flex;
  flex-direction: row;
  justify-content: flex-start;
  align-items: flex-start;
  gap: 16px;
  font-size: 14px;
  overflow-x: auto;
  flex-wrap: nowrap;
  min-width: 100%;
"></div>
</body>
</html>