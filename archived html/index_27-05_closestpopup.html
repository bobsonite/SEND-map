<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SEND Map Prototype</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }

    #search-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      font-family: sans-serif;
    }

    #search-box {
      padding: 6px;
      width: 240px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
  #menu {
  background: white;
  border-radius: 3px;
  padding: 10px;
  font-family: sans-serif;
  font-size: 13px;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 11;
  pointer-events: auto;
}  
</style>
</head>
<body>
<div id="menu" class="mapboxgl-ctrl-top-right">
  <button id="toggle-menu-button">🧭 Layers ▾</button>
  <div id="layer-toggles" style="display: none; margin-top: 8px;">
    <label><input type="checkbox" id="toggle-suspensions" checked> LA Suspensions</label><br>
    <label><input type="checkbox" id="toggle-schools" checked> School Locations</label><br>
    <label><input type="checkbox" id="toggle-transport"> Transport Stops</label>
  </div>
</div>
  <div id="map"></div>
  <div id="search-container">
    <input id="search-box" type="text" placeholder="Search Local Authority..." />
  </div>

  <script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiYm9ic29uaXRlIiwiYSI6ImNtOXpyeWc1aDFlY24ya3M3dm55a2oyNDcifQ.8H2wkga07prlTm_YpOQicA';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v10',
    center: [-1.5, 53.5],
    zoom: 5.4
  });

  let allFeatures = [];

  fetch('data/processed/LASuspensionrate.geojson')
    .then(res => res.json())
    .then(geojson => {
      allFeatures = geojson.features;

      map.on('load', () => {
        map.addSource('suspensions', {
          type: 'geojson',
          data: geojson
        });

        map.addLayer({
          id: 'suspensions-fill',
          type: 'fill',
          source: 'suspensions',
          paint: {
            'fill-color': [
              'interpolate',
              ['linear'],
              ['get', 'susp_rate'],
              0, '#eff3ff',
              2, '#c6dbef',
              3, '#9ecae1',
              4, '#6baed6',
              5, '#3182bd',
              6, '#08519c'
            ],
            'fill-opacity': 0.6
          }
        });

        map.addLayer({
          id: 'suspensions-outline',
          type: 'line',
          source: 'suspensions',
          paint: {
            'line-color': '#000',
            'line-width': 0.5
          }
        });
// Add schools source
map.addSource('schools', {
  type: 'geojson',
  data: 'data/processed/OpenSchoolsSL.geojson'
});

// Add school points as circles
map.addLayer({
  id: 'schools-circle',
  type: 'circle',
  source: 'schools',
  paint: {
    'circle-radius': 4,
    'circle-color': '#f03b20',
    'circle-stroke-color': '#fff',
    'circle-stroke-width': 0.5
  }
});
// 🚏 Add transport source
fetch('data/processed/TransportIcons_Corrected.geojson')
  .then(res => res.json())
  .then(data => {
    transportGeojson = data;

    map.addSource('transport', {
      type: 'geojson',
      data: data
    });

// 🚏 Add transport layer with built-in icons
map.loadImage('https://docs.mapbox.com/mapbox-gl-js/assets/custom_marker.png', (error, image) => {
  if (error) throw error;

  if (!map.hasImage('custom-marker')) {
    map.addImage('custom-marker', image);
  }

  map.addLayer({
    id: 'transport-icons',
    type: 'symbol',
    source: 'transport',
    layout: {
      'icon-image': ['get', 'icon'], // 'bus', 'rail', or 'car'
      'icon-size': 0.7,
      'icon-allow-overlap': true,
'visibility': 'none'
    }
  });
});
});
        // Popup hover
        const popup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false });

        map.on('mousemove', 'suspensions-fill', (e) => {
          map.getCanvas().style.cursor = 'pointer';
          const props = e.features[0].properties;
          popup
            .setLngLat(e.lngLat)
            .setHTML(`<strong>${props.la_name}</strong><br>Suspension rate: ${props.suspension_rate_label}`)
            .addTo(map);
        });

        map.on('mouseleave', 'suspensions-fill', () => {
          map.getCanvas().style.cursor = '';
          popup.remove();
        });

        // Search logic (global)
        document.getElementById('search-box').addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            const query = e.target.value.toLowerCase();
            const match = allFeatures.find(f =>
              f.properties.la_name && f.properties.la_name.toLowerCase().includes(query)
            );

            if (match) {
              const bounds = turf.bbox(match);
              map.fitBounds(bounds, { padding: 50 });
            }
          }
        });
      });
    });
// 🏫 School-level tooltip logic
const schoolPopup = new mapboxgl.Popup({
  closeButton: false,
  closeOnClick: false
});

map.on('mouseenter', 'schools-circle', (e) => {
  map.getCanvas().style.cursor = 'pointer';
  const props = e.features[0].properties;
  schoolPopup.setLngLat(e.lngLat)
    .setHTML(`<strong>${props.EstablishmentName}</strong>`)
    .addTo(map);
});

map.on('mouseleave', 'schools-circle', () => {
  map.getCanvas().style.cursor = '';
  schoolPopup.remove();
});
map.on('click', 'schools-circle', (e) => {
  const schoolCoords = e.features[0].geometry.coordinates;
  const schoolProps = e.features[0].properties;

  const schoolPoint = turf.point(schoolCoords);
  const nearest = transportGeojson.features
    .map(f => {
      const dist = turf.distance(schoolPoint, f);
      return { feature: f, distance: dist };
    })
    .sort((a, b) => a.distance - b.distance)
    .slice(0, 5);

 const transportIcons = {
  AIR: '✈️ Airport',
  BCE: '🚌 Bus Stop (Council-Contracted)',
  BCQ: '🚌 Bus Stop (Council-Qualified)',
  BCS: '🚌 Bus Stop (School)',
  BCT: '🚌 Bus Stop (TfL/Standard)',
  BST: '🚌 Bus Stop (TfL)',
  FBT: '🚐 Flexible Bus Transport',
  FER: '⛴️ Ferry Stop',
  FTD: '⛴️ Ferry Terminal',
  GAT: '🚇 Train Gateway',
  MET: '🚆 Metro Station',
  PLT: '🚇 Tube/Underground Platform',
  RLY: '🚉 Railway Station',
  RPL: '🚆 Rail Platform',
  RSE: '🚊 Rail Service Entry',
  STR: '🚏 Street Pickup',
  TMU: '🚐 Minibus Hub',
  TXR: '🚖 Taxi Rank'
};

  let popupHTML = `<strong>${schoolProps.EstablishmentName}</strong><br><em>Nearest Transport Stops:</em><ul>`;
  nearest.forEach(item => {
    const subtype = item.feature.properties.Subtype;
const label = transportIcons[subtype?.toUpperCase()] || `${subtype}`;
    popupHTML += `<li>${label} — ${item.feature.properties.Name} (${item.distance.toFixed(2)} km)</li>`;
  });
  popupHTML += '</ul>';

  new mapboxgl.Popup()
    .setLngLat(schoolCoords)
    .setHTML(popupHTML)
    .addTo(map);
});
// 🛑 Transport-layer hover popup
const transportPopup = new mapboxgl.Popup({
  closeButton: false,
  closeOnClick: false
});

map.on('mouseenter', 'transport-icons', (e) => {
  map.getCanvas().style.cursor = 'pointer';
  const props = e.features[0].properties;
  transportPopup.setLngLat(e.lngLat)
    .setHTML(`<strong>${props.Name}</strong><br>${props.SubType}`)
    .addTo(map);
});

map.on('mouseleave', 'transport-icons', () => {
  map.getCanvas().style.cursor = '';
  transportPopup.remove();
});
document.getElementById('toggle-suspensions').addEventListener('change', (e) => {
    const visibility = e.target.checked ? 'visible' : 'none';
    map.setLayoutProperty('suspensions-fill', 'visibility', visibility);
    map.setLayoutProperty('suspensions-outline', 'visibility', visibility);
  });

  document.getElementById('toggle-schools').addEventListener('change', (e) => {
    const visibility = e.target.checked ? 'visible' : 'none';
    map.setLayoutProperty('schools-circle', 'visibility', visibility);
  });
document.getElementById('toggle-transport').addEventListener('change', (e) => {
  const visibility = e.target.checked ? 'visible' : 'none';
  map.setLayoutProperty('transport-icons', 'visibility', visibility);
});
document.getElementById('toggle-menu-button').addEventListener('click', () => {
  const toggles = document.getElementById('layer-toggles');
  toggles.style.display = toggles.style.display === 'none' ? 'block' : 'none';
});
</script>
</body>
</html>